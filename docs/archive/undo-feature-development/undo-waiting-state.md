# ✅ 方案 A：按鈕狀態變化 - 實作完成

## 實作時間
2026-01-08 12:35

---

## 📋 修改內容

### 1. 添加 State
```typescript
const [isWaitingUndo, setIsWaitingUndo] = useState(false);
```

### 2. 請求悔棋時設置狀態
```typescript
const handleRequestUndo = () => {
  // ... 檢查邏輯
  setIsWaitingUndo(true);  // ✅ 設置等待狀態
  socketService.requestUndo();
};
```

### 3. 收到回應時清除狀態
```typescript
// 悔棋成功
socketService.onUndoAccepted(() => {
  // ...
  setIsWaitingUndo(false);  // ✅ 清除等待狀態
});

// 悔棋被拒絕
socketService.onUndoRejected(() => {
  // ...
  setIsWaitingUndo(false);  // ✅ 清除等待狀態
});
```

### 4. 更新按鈕 UI
```typescript
<button
  disabled={!isConnected || isWaitingUndo || room.settings.undoLimit === 0}
  className={`... ${
    isWaitingUndo
      ? 'bg-gray-300 text-gray-600 cursor-wait'
      : isConnected && room.settings.undoLimit !== 0
        ? 'bg-purple-500 text-white hover:bg-purple-600'
        : 'bg-gray-200 text-gray-400 cursor-not-allowed'
  }`}
>
  {isWaitingUndo ? (
    <>
      <span className="animate-spin">⏳</span>
      <span>等待對方回應...</span>
    </>
  ) : (
    <>
      <span>♻️</span>
      <span>請求悔棋</span>
      {/* 次數顯示 */}
    </>
  )}
</button>
```

---

## 🎨 UI 狀態

### 初始狀態
```
┌─────────────────────────────────┐
│  ♻️ 請求悔棋 (1/3)              │ ← 紫色，可點擊
└─────────────────────────────────┘
```

### 等待狀態（點擊後）
```
┌─────────────────────────────────┐
│  ⏳ 等待對方回應...              │ ← 灰色，禁用，旋轉動畫
└─────────────────────────────────┘
```

### 成功後
```
恢復為初始狀態，次數 +1
┌─────────────────────────────────┐
│  ♻️ 請求悔棋 (2/3)              │
└─────────────────────────────────┘
```

### 拒絕後
```
顯示 alert，然後恢復初始狀態
Alert: "對方拒絕了悔棋請求"
┌─────────────────────────────────┐
│  ♻️ 請求悔棋 (1/3)              │
└─────────────────────────────────┘
```

---

## 🔄 完整流程

```
玩家 A 點擊「請求悔棋」
    ↓
按鈕變為「⏳ 等待對方回應...」
    ↓
按鈕禁用（防止重複點擊）
    ↓
灰色背景 + cursor-wait
    ↓
⏳ 圖示旋轉動畫
    ↓
等待對方回應...
    ↓
對方同意 → 按鈕恢復，次數 +1
或
對方拒絕 → 顯示 alert，按鈕恢復
```

---

## ✅ 功能特點

| 特點 | 說明 |
|------|------|
| ✅ 視覺反饋 | 按鈕文字和圖示變化 |
| ✅ 防止重複點擊 | 等待時按鈕禁用 |
| ✅ 載入動畫 | ⏳ 圖示旋轉 |
| ✅ 狀態清晰 | 「等待對方回應...」文字 |
| ✅ 自動恢復 | 收到回應後自動恢復 |
| ✅ 實作簡單 | 只需 1 個 state |

---

## 🎯 CSS 類別

### 等待狀態
- `bg-gray-300` - 灰色背景
- `text-gray-600` - 深灰色文字
- `cursor-wait` - 等待游標
- `animate-spin` - 旋轉動畫（⏳）

### 正常狀態
- `bg-purple-500` - 紫色背景
- `text-white` - 白色文字
- `hover:bg-purple-600` - 懸停效果
- `active:scale-95` - 點擊縮放

### 禁用狀態
- `bg-gray-200` - 淺灰色背景
- `text-gray-400` - 淺灰色文字
- `cursor-not-allowed` - 禁止游標

---

## 📝 測試步驟

### 測試 1：基本等待狀態
1. 創建房間
2. 等待對手加入
3. 下一步棋
4. 點擊「請求悔棋」
5. **預期**：按鈕變為「⏳ 等待對方回應...」
6. **預期**：按鈕禁用，無法再次點擊
7. **預期**：⏳ 圖示旋轉

### 測試 2：對方同意
1. 請求悔棋
2. 對方點擊「同意」
3. **預期**：按鈕恢復為「♻️ 請求悔棋 (2/3)」
4. **預期**：按鈕可再次點擊

### 測試 3：對方拒絕
1. 請求悔棋
2. 對方點擊「拒絕」
3. **預期**：顯示 alert「對方拒絕了悔棋請求」
4. **預期**：按鈕恢復為「♻️ 請求悔棋 (1/3)」

### 測試 4：防止重複點擊
1. 請求悔棋
2. 嘗試再次點擊按鈕
3. **預期**：按鈕禁用，無法點擊

---

## ✅ 實作完成

**方案 A 已完整實作！**

**改善效果**：
- ✅ 用戶知道請求已發送
- ✅ 用戶知道正在等待
- ✅ 防止重複點擊
- ✅ 清晰的視覺反饋

---

**版本**：v2.4.1  
**狀態**：✅ 完成，可以測試
