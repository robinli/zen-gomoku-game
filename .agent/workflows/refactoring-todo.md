# 重構待辦項目清單

**更新時間**: 2026-01-16 10:56  
**總項目數**: 18 項  
**已完成**: 5 項 (28%)  
**部分完成**: 2 項  
**未開始**: 11 項

---

## ✅ 已完成項目 (5/18)

### 1. ✅ 項目 1: 拆分 App.tsx 龐大組件
- **狀態**: ✅ 完成
- **工時**: 8 小時
- **完成日期**: 2026-01-16

**完成內容** (依據 app-refactoring-plan.md):

#### 階段 1: 創建新的 Hook ✅
- ✅ **useDialogs Hook** (50 行)
  - 管理 5 個對話框狀態
  - 提供輔助方法 (showSuccess, showError, showInfo)
  - 15 個測試用例

- ✅ **useConnection Hook** (61 行)
  - 管理 4 個連線狀態 (isConnected, isConnecting, isReconnecting, error)
  - 提供 connect, disconnect, setError 方法
  - 簡化版本（移除了不存在的事件監聽器）

#### 階段 2: 整合現有 Hook ✅
- ✅ **整合 useReplay Hook**
  - 移除 App.tsx 中 5 個重複的回放狀態
  - 移除 87 行回放函數
  - 使用 replay.* 訪問所有功能

- ✅ **整合 useGameActions Hook**
  - 移除 105 行遊戲動作函數
  - 使用 gameActions.* 訪問所有功能

- ✅ **整合 useRoomStats Hook**
  - 已在之前完成

#### 階段 3: 重構 App.tsx ✅
- ✅ 修復所有 TypeScript 錯誤
- ✅ 清理未使用文件
  - 刪除 geminiService.ts (空文件)
  - 刪除 gameReducer.ts (已用 Hooks 替代)
  - 刪除 secureStorage.ts + 測試 (未被使用)

**成果**:
```
重構前 App.tsx:      935 行
├─ useDialogs:      -127 行
├─ useConnection:     -1 行
├─ useReplay:        -84 行
├─ useGameActions:   -73 行
└─ 最終:             649 行 ✅

總減少: 286 行 (30.6%)
```

**代碼質量提升**:
- useState: 20+ → 6 (-70%)
- useEffect: 15+ → 5 (-67%)
- 函數: 30+ → 15 (-50%)
- 測試: 182/182 通過 ✅

**未完成部分** (留待未來):
- ⏳ useSocketEvents Hook (Socket 事件已在 App.tsx 中處理)
- ⏳ useRoomJoin Hook (可選優化)
- ⏳ useNavigation Hook (可選優化)
- ⏳ Context 管理全局狀態

---

### 2. ✅ 項目 3: 修復 Socket.IO CDN 依賴
- **狀態**: 完成
- **工時**: 2 小時
- **完成日期**: 2026-01-14

---

### 3. ✅ 項目 6: 提取配置常數
- **狀態**: 完成
- **工時**: 2.5 小時
- **完成日期**: 2026-01-14

---

### 4. ✅ 項目 14: 加密 LocalStorage 資料
- **狀態**: 完成 (後來移除，因為未使用)
- **工時**: 20 分鐘
- **完成日期**: 2026-01-14

---

### 5. ✅ 項目 8 (部分): 創建 Logger 工具
- **狀態**: 工具已完成
- **工時**: 20 分鐘
- **待完成**: 替換 117 處 console.log

---

## 🔄 部分完成項目 (2/18)

### 6. 🔄 項目 8: 移除生產環境 Console.log (30% 完成)
**已投入**: 20 分鐘  
**剩餘**: 2.5-3.5 小時

**已完成**:
- ✅ Logger 工具已創建

**待完成**:
- [ ] 替換客戶端 console.log (68 處)
- [ ] 替換服務端 console.log (49 處)
- [ ] 測試

---

### 7. 🔄 項目 13: 優化 Strict Mode (50% 完成)
**已投入**: 15 分鐘  
**剩餘**: 5-10 分鐘

**已完成**:
- ✅ useEffectOnce Hook 已創建

**待完成**:
- [ ] 在 App.tsx 替換 hasInitialized ref (已使用但可優化)
- [ ] 測試

---

## ⏳ 未開始項目 (11/18)

### 🔴 高優先級 (P0) - 1 項

#### 項目 2: 統一狀態管理邏輯
**預估工時**: 4-6 小時  
**依賴**: 項目 1 ✅ (已完成)

**任務**:
- [ ] 評估是否需要 Context (目前 Hooks 已足夠)
- [ ] 考慮使用 useReducer 優化複雜狀態
- [ ] 實現狀態持久化機制 (如需要)

**備註**: gameReducer.ts 已刪除（改用 Hooks 模式）

---

### 🟡 中優先級 (P1) - 4 項

#### 項目 4: 重構 Socket 事件監聽器
**預估工時**: 6-8 小時  
**狀態**: 可選（目前在 App.tsx 中處理良好）

**任務**:
- [ ] 評估是否需要 useSocketEvents Hook
- [ ] 如需要，實現自動清理機制
- [ ] 統一事件處理邏輯

**備註**: 目前 Socket 事件在 App.tsx 中集中處理，結構清晰

---

#### 項目 5: 統一類型定義
**預估工時**: 4-6 小時

**任務**:
- [ ] 創建共享類型套件
- [ ] 統一 client 和 server 的類型定義
- [ ] 消除重複定義

**問題**: client/src/types.ts 和 server/src/types.ts 有大量重複

---

#### 項目 7: 統一錯誤處理機制
**預估工時**: 4-5 小時

**任務**:
- [ ] 創建自定義錯誤類別
- [ ] 實現全局錯誤處理器
- [ ] 統一錯誤訊息格式

---

#### 項目 11: 添加單元測試
**預估工時**: 8-12 小時 (部分已完成)

**已完成**:
- ✅ Vitest + React Testing Library 已設置
- ✅ Hook 測試已完成 (useDialogs, useReplay, useGameActions, useRoomStats, useEffectOnce)
- ✅ 組件測試已完成 (Board, GameInfo)
- ✅ 工具測試已完成 (gameLogic, logger)

**待完成**:
- [ ] 增加更多組件測試覆蓋率
- [ ] 增加集成測試
- [ ] 提升測試覆蓋率到 80%+

**當前狀態**: 182 個測試全部通過 ✅

---

### 🟢 低優先級 (P2) - 7 項

#### 項目 9: 重構 CSS 樣式
**預估工時**: 6-8 小時

**任務**:
- [ ] 提取常用樣式為組件
- [ ] 考慮使用 CSS Modules 或 styled-components

---

#### 項目 10: Server 端國際化
**預估工時**: 3-4 小時

**任務**:
- [ ] 整合 i18next
- [ ] 支援多語言錯誤訊息

---

#### 項目 12: 共享遊戲邏輯
**預估工時**: 4-6 小時

**任務**:
- [ ] 移動 gameLogic.ts 到共享套件
- [ ] 確保邏輯一致性

**問題**: gameLogic.ts 在 client 和 server 都有

---

#### 項目 15: 啟用 TypeScript 嚴格模式
**預估工時**: 4-6 小時

**任務**:
- [ ] 啟用 strict: true
- [ ] 修復所有類型錯誤

---

#### 項目 16: React 性能優化
**預估工時**: 4-6 小時

**任務**:
- [ ] 使用 React.memo
- [ ] 使用 useMemo 和 useCallback
- [ ] 使用 React Profiler 分析

---

#### 項目 17: 棋盤渲染優化
**預估工時**: 4-5 小時

**任務**:
- [ ] 只更新變化的格子
- [ ] 考慮使用 Canvas 渲染

**問題**: 每次更新重繪整個棋盤 (225 個格子)

---

#### 項目 18: 加強安全性
**預估工時**: 4-6 小時

**任務**:
- [ ] 限制 CORS origin
- [ ] 使用 Zod 驗證輸入
- [ ] 添加速率限制

---

## 📊 統計總覽

### 完成度
| 狀態 | 數量 | 百分比 |
|------|------|--------|
| ✅ 完成 | 5 | 28% |
| 🔄 部分完成 | 2 | 11% |
| ⏳ 未開始 | 11 | 61% |

### 工時統計
| 項目 | 已投入 | 剩餘預估 |
|------|--------|----------|
| 已完成 | 13h | 0h |
| 部分完成 | 35min | 3-4h |
| 未開始 | 0h | 55-83h |
| **總計** | **13.5h** | **58-87h** |

### 優先級分布
| 優先級 | 總數 | 已完成 | 部分完成 | 未開始 |
|--------|------|--------|----------|--------|
| 🔴 P0 | 3 | 2 | 1 | 0 |
| 🟡 P1 | 4 | 0 | 0 | 4 |
| 🟢 P2 | 11 | 3 | 1 | 7 |

---

## 🎯 建議的執行順序

### 短期 (本週)
1. **完成項目 13** (5-10 分鐘) - 最簡單
2. **項目 5**: 統一類型定義 (4-6 小時) - 高價值
3. **項目 8**: 替換 console.log (2.5-3.5h)

### 中期 (2-3 週)
4. **項目 11**: 增加測試覆蓋率 (8-12h)
5. **項目 7**: 統一錯誤處理 (4-5h)
6. **項目 2**: 評估狀態管理需求 (2-4h)

### 長期 (1-2 月)
7. 性能優化項目 (16, 17)
8. 安全性加強 (18)
9. 其他優化項目

---

## 💡 快速勝利項目 (Quick Wins)

如果時間有限，優先完成這些：

1. **項目 13** (5-10 分鐘) ⭐⭐⭐
   - 只需替換 3 處代碼
   - Hook 已創建
   - 立即可完成

2. **項目 10** (3-4 小時) ⭐
   - 獨立功能
   - 不影響其他部分

---

## 🔥 高影響項目

這些項目完成後影響最大：

1. ✅ **項目 1**: 拆分 App.tsx (已完成)
   - ✅ 大幅提升可維護性
   - ✅ 減少 App.tsx 從 935 行到 649 行 (-30.6%)
   - ✅ 代碼質量顯著提升

2. **項目 5**: 統一類型定義
   - 消除重複
   - 提升類型安全
   - 減少維護成本

3. **項目 11**: 增加測試覆蓋率
   - 保證重構質量
   - 減少回歸風險
   - 提升信心

---

## 📝 最新成就 (2026-01-16)

### 完成的工作
1. ✅ **項目 1 完成** (8h)
   - 創建 useDialogs Hook (50 行, 15 測試)
   - 創建 useConnection Hook (61 行)
   - 整合 useReplay Hook (移除 87 行)
   - 整合 useGameActions Hook (移除 105 行)
   - 整合 useRoomStats Hook
   - 清理 4 個未使用文件
   - 修復所有 TypeScript 錯誤
   - App.tsx: 935 → 649 行 (-30.6%)
   - 測試: 182/182 通過 ✅

### 代碼變更統計
- **新增 Hook**: 2 個 (useDialogs, useConnection)
- **整合 Hook**: 3 個 (useReplay, useGameActions, useRoomStats)
- **刪除文件**: 4 個 (geminiService, gameReducer, secureStorage + 測試)
- **代碼減少**: 286 行 (-30.6%)
- **測試文件**: 9 個
- **測試用例**: 182 個 (100% 通過)
- **Git 提交**: 4 個

### 創建的 Hook 清單
```
✅ useDialogs.ts (50 行)
✅ useConnection.ts (61 行)
✅ useReplay.ts (已存在，已整合)
✅ useGameActions.ts (已存在，已整合)
✅ useRoomStats.ts (已存在，已整合)
✅ useEffectOnce.ts (已存在)
```

---

## 🎯 下一次工作建議

### 如果有 30 分鐘
- 完成項目 13 (5-10 分鐘)
- 開始項目 5 (統一類型定義)

### 如果有 2 小時
- 完成項目 13
- 開始項目 5 或項目 8

### 如果有 4+ 小時
- 完成項目 13
- 完成項目 5 (統一類型定義)
- 或開始項目 11 (增加測試覆蓋率)

---

## 📈 重構進度追蹤

### 項目 1 詳細進度 (100% 完成)
- ✅ 階段 1: 創建 Hook (100%)
  - ✅ useDialogs Hook
  - ✅ useConnection Hook
  - ⏳ useSocketEvents Hook (可選，未實現)
  
- ✅ 階段 2: 整合現有 Hook (100%)
  - ✅ useReplay Hook
  - ✅ useGameActions Hook
  - ✅ useRoomStats Hook
  
- ✅ 階段 3: 重構 App.tsx (100%)
  - ✅ 移除重複代碼
  - ✅ 修復 TypeScript 錯誤
  - ✅ 清理未使用文件
  - ✅ 測試驗證

### 代碼質量指標
```
指標                重構前    重構後    改善
─────────────────────────────────────
App.tsx 行數        935      649      -30.6%
useState 數量       20+      6        -70%
useEffect 數量      15+      5        -67%
函數數量            30+      15       -50%
測試通過率          100%     100%     ✅
TypeScript 錯誤     多個     0        ✅
```

---

**創建時間**: 2026-01-14 20:14  
**更新時間**: 2026-01-16 10:56  
**狀態**: 🎉 項目 1 完成！進度優秀！  
**完成度**: 28% (5/18 項目)  
**下一目標**: 項目 5 (統一類型定義) 或 項目 13 (快速勝利)
