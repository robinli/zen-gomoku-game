# 項目 2 重構進度報告

**狀態**: ⚠️ 暫停 - 需要重新評估  
**原因**: 重構範圍過大，需要更謹慎的方法

---

## 🔍 問題分析

### 當前狀況
- ✅ 已創建 `gameReducer.ts` (完成)
- ✅ 已更新 App.tsx 導入和初始化 (完成)
- ❌ 需要更新 ~300+ 處狀態引用 (未完成)

### 發現的問題
1. **影響範圍過大**: App.tsx 有 980 行，幾乎每個函數都使用這些狀態
2. **風險過高**: 一次性更改太多可能導致難以調試的問題
3. **測試困難**: 沒有單元測試的情況下，很難確保重構正確性

---

## 💡 建議的替代方案

### 方案 A: 漸進式重構 (推薦)
**步驟**:
1. 先完成**項目 1** (拆分 App.tsx)
2. 在拆分過程中逐步引入 reducer
3. 每個拆分出的 Hook 使用 reducer 管理自己的狀態

**優點**:
- 風險更低
- 更容易測試
- 符合單一職責原則

**預估工時**: 12-16 小時 (包含項目 1)

### 方案 B: 完成當前重構 (高風險)
**步驟**:
1. 創建狀態映射輔助函數
2. 批量替換所有 `setXxx` 為 `dispatch`
3. 批量替換所有狀態引用為 `state.xxx`
4. 大量測試和調試

**優點**:
- 一次性完成
- 狀態管理更統一

**缺點**:
- 需要更改 300+ 處代碼
- 很容易出錯
- 調試困難

**預估工時**: 8-12 小時 (不包含調試時間)

### 方案 C: 僅重構統計邏輯 (最小化)
**步驟**:
1. 只使用 reducer 管理 `roomStats`
2. 移除 `roomStatsRef`
3. 其他狀態保持不變

**優點**:
- 風險最低
- 解決了主要問題 (ref/state 同步)
- 工時最少

**預估工時**: 2-3 小時

---

## 🎯 建議

我強烈建議採用**方案 A (漸進式重構)**，原因：

1. **更安全**: 每個小步驟都可以測試
2. **更符合最佳實踐**: 先拆分組件，再優化狀態管理
3. **更易維護**: 小的、專注的 Hook 比大的 reducer 更容易理解

### 執行順序
1. ✅ 項目 3: 修復 Socket.IO CDN (已完成)
2. ✅ 項目 6: 提取配置常數 (已完成)
3. 🔄 **項目 1: 拆分 App.tsx** (建議下一步)
   - 創建 `useSocketEvents` Hook
   - 創建 `useReplay` Hook  
   - 創建 `useRoomStats` Hook
   - 在這些 Hook 中使用 reducer
4. 🔄 項目 2: 統一狀態管理 (作為項目 1 的一部分)

---

## 📊 當前進度

### 已完成
- [x] 創建 `gameReducer.ts`
- [x] 定義所有 action types
- [x] 實現 reducer 邏輯
- [x] 更新 App.tsx 導入

### 未完成 (需要回退)
- [ ] 更新所有狀態引用
- [ ] 更新所有 dispatch 調用
- [ ] 測試所有功能

---

## 🔄 建議的下一步行動

### 選項 1: 回退並採用方案 A
```bash
# 回退 App.tsx 的更改
git checkout HEAD -- client/src/App.tsx

# 保留 gameReducer.ts 供後續使用
# 開始執行項目 1
```

### 選項 2: 繼續完成方案 B
需要您確認願意投入額外的時間和風險

### 選項 3: 採用方案 C (最小化)
只修復 roomStats 的同步問題

---

## ❓ 請您決定

您希望：
1. **回退並採用方案 A** - 先拆分 App.tsx (推薦)
2. **繼續方案 B** - 完成完整的 reducer 重構 (高風險)
3. **採用方案 C** - 只修復 roomStats 問題 (最小化)

請告訴我您的選擇，我會相應調整執行計劃。

---

**創建時間**: 2026-01-14 13:40  
**狀態**: 等待決策
