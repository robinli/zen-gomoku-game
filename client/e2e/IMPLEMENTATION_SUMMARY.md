# E2E 測試實作總結

## 📋 實作內容

本次實作新增了一個完整的端到端測試案例，涵蓋從玩家加入到遊戲結束再到回放的完整流程。

## 🎯 測試目標

測試以下五個階段：
1. ✅ 第一個玩家加入（創建房間）
2. ✅ 第二個玩家加入（使用分享連結）
3. ✅ 兩個玩家完成一局遊戲（9步，黑棋勝利）
4. ✅ 第一個玩家回放，等回放結束（自動回放）
5. ✅ 關閉回放

## 📁 新增/修改的文件

### 1. `e2e/helpers.ts` (修改)
新增了五個輔助函數：

- **`playFullGame(player1Page, player2Page, moves)`**
  - 功能：自動執行完整的遊戲流程
  - 參數：兩個玩家的 Page 對象和棋步序列
  - 自動輪流下棋並等待對方更新

- **`closeGameEndDialog(page)`** ⭐ 重要
  - 功能：關閉遊戲結束對話框
  - 遊戲結束後會彈出勝負視窗，必須先關閉才能點擊回放
  - 嘗試多種選擇器以確保能找到關閉按鈕

- **`startReplay(page)`**
  - 功能：開始回放
  - 點擊「回放對局」按鈕
  - 驗證回放控制面板出現

- **`waitForReplayComplete(page, totalSteps, timeoutMs)`**
  - 功能：等待自動回放完成
  - 使用固定時間等待策略（每步約 1 秒）
  - 更穩定可靠

- **`exitReplay(page)`**
  - 功能：退出回放模式
  - 點擊退出按鈕（X 圖標）
  - 驗證回放控制面板消失

### 2. `e2e/full-game-replay.spec.ts` (新增)
完整的測試案例文件，包含：

- 詳細的測試流程註釋
- 四個測試階段的實作
- 每個階段的截圖保存
- 完整的錯誤處理

**測試數據：**
```typescript
// 黑棋勝利的 9 步棋譜
const winningMoves = [
    { row: 7, col: 7 },   // 黑 1
    { row: 7, col: 8 },   // 白 2
    { row: 8, col: 7 },   // 黑 3
    { row: 8, col: 8 },   // 白 4
    { row: 9, col: 7 },   // 黑 5
    { row: 9, col: 8 },   // 白 6
    { row: 10, col: 7 },  // 黑 7
    { row: 10, col: 8 },  // 白 8
    { row: 11, col: 7 },  // 黑 9 - 勝利！
];
```

### 3. `e2e/README.md` (更新)
更新了文檔內容：
- 新增測試案例說明
- 更新輔助函數列表
- 更新未來擴展清單

## 🚀 如何運行測試

### 前置條件
確保服務器和客戶端都在運行：

```bash
# 終端 1 - 啟動服務器
cd server
npm run dev

# 終端 2 - 啟動客戶端
cd client
npm run dev
```

### 運行測試

```bash
# 在 client 目錄下
cd client

# UI 模式（推薦）- 可視化測試過程
npm run test:e2e:ui

# 無頭模式 - 在後台運行
npm run test:e2e

# 有頭模式 - 看到瀏覽器窗口
npm run test:e2e:headed

# 調試模式 - 逐步執行
npm run test:e2e:debug
```

### 只運行新的測試

```bash
npx playwright test full-game-replay.spec.ts
```

## 📸 測試截圖

測試會在以下時間點自動截圖：

1. `01-player1-created-room.png` - 玩家1創建房間後
2. `02-player1-ready.png` - 玩家1棋盤準備好
3. `03-player2-ready.png` - 玩家2棋盤準備好
4. `04-game-ended-player1.png` - 遊戲結束（玩家1視角）
5. `05-game-ended-player2.png` - 遊戲結束（玩家2視角）
6. `06-replay-started.png` - 回放開始
7. `07-replay-completed.png` - 回放完成
8. `08-replay-exited.png` - 退出回放

所有截圖保存在：`e2e/test-results/`

## 🔍 測試日誌

測試會輸出詳細的日誌：

```
========== 階段 1: 玩家加入 ==========
🔵 玩家 1 創建房間...
✅ 房間已創建: http://localhost:5173/#room=xxx
🟢 玩家 2 加入房間...
✅ 玩家 2 已加入房間
✅ 兩個玩家都已準備好！

========== 階段 2: 完成一局遊戲 ==========
🎮 開始下棋，共 9 步...
玩家1(黑) 下棋: (7, 7)
✅ 第 1 步完成
...
✅ 遊戲完成！
✅ 遊戲已結束，黑棋勝利！

========== 階段 3: 第一個玩家回放 ==========
🔘 關閉遊戲結束對話框...
✅ 已點擊關閉按鈕
✅ 遊戲結束對話框已關閉
🎬 開始回放...
✅ 已點擊回放按鈕
✅ 回放模式已啟動
⏳ 等待回放完成（共 9 步）...
📊 預計回放時間: 12.0 秒
✅ 回放完成！耗時 X.X 秒

========== 階段 4: 關閉回放 ==========
🚪 退出回放...
✅ 已點擊退出按鈕
✅ 已退出回放模式！

========== 最終驗證 ==========
✅ 所有測試通過！
```

## ✅ 測試覆蓋範圍

此測試涵蓋了以下功能：

- [x] 房間創建
- [x] 玩家加入
- [x] Socket 連線
- [x] 棋盤準備
- [x] 輪流下棋
- [x] 遊戲狀態同步
- [x] 勝負判定
- [x] 關閉遊戲結束對話框 ⭐ 重要
- [x] 回放啟動
- [x] 自動回放
- [x] 回放進度監控
- [x] 退出回放

## 🎯 技術亮點

1. **雙瀏覽器上下文**：使用兩個獨立的瀏覽器上下文模擬真實的多人對弈
2. **自動化遊戲流程**：通過 `playFullGame` 函數自動執行完整的遊戲
3. **智能等待**：使用 `waitForFunction` 監控回放進度
4. **詳細日誌**：每個步驟都有清晰的日誌輸出
5. **完整截圖**：每個關鍵階段都保存截圖便於調試

## 🐛 潛在問題與解決方案

### 問題1：回放進度檢測可能失敗
**原因**：DOM 結構變化或文字格式不同
**解決**：使用靈活的正則表達式匹配 `(\d+)\s*\/\s*(\d+)`

### 問題2：網絡延遲導致測試不穩定
**原因**：Socket 通訊需要時間
**解決**：在每次落子後等待 800ms 確保雙方同步

### 問題3：找不到退出按鈕
**原因**：按鈕選擇器可能不準確
**解決**：使用多個選擇器備選：`button[title*="結束"], button[title*="End"], button:has-text("×")`

## 📝 後續改進建議

1. **參數化測試**：支援不同的棋譜和勝利條件
2. **錯誤場景**：測試回放時斷線等異常情況
3. **性能測試**：測試大量棋步的回放性能
4. **回放控制**：測試暫停、快進、後退等功能
5. **多語言測試**：測試英文界面下的回放功能

## 🎉 總結

成功實作了一個完整的端到端測試案例，涵蓋了從玩家加入到遊戲結束再到回放的完整流程。測試具有良好的可讀性、穩定性和可維護性，為項目的品質保證提供了堅實的基礎。
